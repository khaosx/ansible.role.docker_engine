---
- name: Ensure stack directory exists
  ansible.builtin.file:
    path: "{{ docker_engine_stacks_dir }}/{{ docker_engine_stack_name }}"
    state: directory
    owner: root
    group: "{{ docker_engine_group }}"
    mode: "2775"

- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-tools/docker-compose.yml.j2
    dest: "{{ docker_engine_stacks_dir }}/{{ docker_engine_stack_name }}/docker-compose.yml"
    owner: root
    group: "{{ docker_engine_group }}"
    mode: "0644"

- name: Deploy stack via Docker Compose v2
  community.docker.docker_compose_v2:
    project_name: "{{ docker_engine_stack_name }}"
    project_src: "{{ docker_engine_stacks_dir }}/{{ docker_engine_stack_name }}"
    files:
      - docker-compose.yml
    state: present
    remove_orphans: true
